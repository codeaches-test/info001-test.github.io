---
layout: default
title: "Create A Stream using SCDF and SCDF shell"
description: "Create and deploy a Stream using Spring Cloud Data Flow Server (SCDF) and SCDF shell"

nav_order: 2
parent: "Spring Cloud Stream"

references_file: references.md

permalink: /spring-cloud-stream/create-stream-using-scdf

gh-repo: codeaches/scdf-pcf-stream
gh-badge: [star, watch, follow]

date: 2019-02-19 1:00:00 -0700
---

In this tutorial, let's download SCDF Shell and use it to create a simple ``http|log`` stream on cloudfoundry(PCF). 

This stream consumes payload over HTTP and prints it to the log. We shall use out-of-the-box `http` source application to consume data and `log` sink application to print the data. 

> We need Spring Cloud Data Flow Server (SCDF) for creating and deploying the stream to cloudfoundry, the tutorial of which can be found at [Deploy SCDF to PCF]{:target="_blank"}.

## Table of contents
{: .no_toc }

1. TOC
{:toc}

---

## Prerequisites

 - [Open Source JDK 11]{:target="_blank"}
 - An account on Pivotal Cloud Foundry (PCF). You can create one [here](https://console.run.pivotal.io/){:target="_blank"}
 - A running SCDF server on PCF. You can follow the steps found at [Deploy SCDF to PCF]{:target="_blank"}.

## Download Spring Cloud Dataflow Shell

`Spring Cloud Dataflow Shell` is a command line interface (CLI) which can be used to connect to SCDF Server. We shall use this CLI to deploy streams. 

Let's download the SCDF shell jar file using wget command.

```sh
$ wget http://repo.spring.io/release/org/springframework/cloud/spring-cloud-dataflow-shell/1.7.4.RELEASE/spring-cloud-dataflow-shell-1.7.4.RELEASE.jar
```

## Connect to SCDF Server from SCDF shell

Start the `spring-cloud-dataflow-shell` spring boot application using `java -jar` command.

```sh
$ java -jar spring-cloud-dataflow-shell-1.7.4.RELEASE.jar
  ____                              ____ _                __
 / ___| _ __  _ __(_)_ __   __ _   / ___| | ___  _   _  __| |
 \___ \| '_ \| '__| | '_ \ / _` | | |   | |/ _ \| | | |/ _` |
  ___) | |_) | |  | | | | | (_| | | |___| | (_) | |_| | (_| |
 |____/| .__/|_|  |_|_| |_|\__, |  \____|_|\___/ \__,_|\__,_|
  ____ |_|    _          __|___/                 __________
 |  _ \  __ _| |_ __ _  |  ___| | _____      __  \ \ \ \ \ \
 | | | |/ _` | __/ _` | | |_  | |/ _ \ \ /\ / /   \ \ \ \ \ \
 | |_| | (_| | || (_| | |  _| | | (_) \ V  V /    / / / / / /
 |____/ \__,_|\__\__,_| |_|   |_|\___/ \_/\_/    /_/_/_/_/_/

1.7.4.RELEASE

Welcome to the Spring Cloud Data Flow shell. For assistance hit TAB or type "help".
server-unknown:>
```

Connect to SCDF Server using the route generated by cloudfoundry for the SCDF server. 

> We will need to pass the URL and credentials of SCDF server(If you have enabled the authentication).

```sh
server-unknown:>dataflow config server --uri "https://codeaches-scdf-server.cfapps.io" --username "user001" --password "pass001" --skip-ssl-validation "true"

Shell mode: classic, Server mode: classic
dataflow:>
```

## Create a `http|log` Stream

Cloudfoundry provides with few out-of-the-box source and sink spring boot applications which can be used for stream creation. Lets register the out-of-the-box `http` and `log` spring boot apps, specific to `rabbit` messaging broker, in SCDF server.

```sh
dataflow:>app register --name http --type source --uri maven://org.springframework.cloud.stream.app:http-source-rabbit:2.1.0.RELEASE
Successfully registered application 'source:http'

dataflow:>app register --name log --type sink --uri maven://org.springframework.cloud.stream.app:log-sink-rabbit:2.1.0.RELEASE
Successfully registered application 'sink:log'
```

Let's utilize the above registered apps `http` and `log` to create `http|log` stream using `stream create` command on SCDF shell terminal. 

> This stream  will take HTTP POST request and prints the body in log file.

```sh
dataflow:>stream create --name httpLogStream --definition "http | log" --deploy

Created new stream 'httpLogStream'
Deployment request has been sent
```

## Validate the `http|log` stream deployment on PCF

Log into PCF using the `cf login` command. Replace `<email>`, `<password>`, `<org>` and `<space>` with values specific to your cloudfoundry account.

```sh
$ cf login -a api.run.pivotal.io -u "<email>" -p "<password>"  -o "<org>" -s "<space>"

API endpoint: api.run.pivotal.io
Authenticating...
OK
Targeted org <org>
Targeted space <space>

API endpoint:   https://api.run.pivotal.io (API version: 2.128.0)
User:           <email>
Org:            <org>
Space:          <space>
```

***Once the stream creation and deployment is successful, PCF creates random routes (urls) for both log and sink applications which can be validated using `cf apps` command***

```sh
$ cf apps
Getting apps in org org <org> / space <space> as <email>
OK

name                                          requested state   instances   memory   disk   urls
data-flow-server-hd6lIb0-httpLogStream-http   started           1/1         1G       1G     data-flow-server-hd6lIb0-httpLogStream-http.cfapps.io
data-flow-server-hd6lIb0-httpLogStream-log    started           1/1         1G       1G     data-flow-server-hd6lIb0-httpLogStream-log.cfapps.io
```

## Test the Stream {#test_stream}

**Post a sample message to the stream**

Post a sample `hello world` message to `http` application using the route `data-flow-server-hd6lIb0-httpLogStream-http.cfapps.io` as shown below. The message will be picked up by `http` app and passed to `log` application.

```sh
$ curl -i -H "Content-Type:application/text" -X POST -d 'hello world' https://data-flow-server-hd6lIb0-httpLogStream-http.cfapps.io

  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100    15    0     0  100    15      0     21 --:--:-- --:--:-- --:--:--    21HTTP/1.1 202 Accepted
X-Vcap-Request-Id: f0282b62-c09f-4c23-4e90-0f374ba2cca9
Content-Length: 0
Connection: keep-alive
```
Once the message is posted successfully, `hello world` will be printed in the logs of `log` application.

**Tail the log of ``log`` application using ``cf logs `` command**

Tail the log of ``data-flow-server-hd6lIb0-httpLogStream-log`` application using `cf logs` command.

```sh
cf logs --recent data-flow-server-hd6lIb0-httpLogStream-log

Retrieving logs for app data-flow-server-hd6lIb0-httpLogStream-log in org <org> / space <space> as <email>...
...
...
2019-02-18T06:39:43.77-0700 [APP/PROC/WEB/0] OUT 2019-02-18 13:39:43.758  INFO 14 --- [httpLogStream-1] data-flow-server-hd6lIb0-httpLogStream-log : hello world
```

## Summary {#summary}

Congratulations! You just deployed a stream on PCF using SCDF Server and created a `http|log` stream using SCDF shell.

{% include_relative {{ page.references_file }} %}
